<div class="container">
  <h1>Catálogo de Productos</h1>
  
  <!-- Filtros y búsqueda -->
  <div class="filters">
    <form method="get" action="/products">
      <div class="filter-group">
        <label for="query">Categoría/Disponibilidad:</label>
        <input type="text" id="query" name="query" placeholder="Ej: electronics, true" />
      </div>
      
      <div class="filter-group">
        <label for="sort">Ordenar por precio:</label>
        <select id="sort" name="sort">
          <option value="">Sin ordenar</option>
          <option value="asc">Ascendente (menor a mayor)</option>
          <option value="desc">Descendente (mayor a menor)</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="limit">Productos por página:</label>
        <select id="limit" name="limit">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
      
      <button type="submit">Filtrar</button>
    </form>
  </div>

  <!-- Listado de productos -->
  {{#if products}}
    <div class="products-grid">
      {{#each products}}
        <div class="product-card" data-pid="{{this._id}}">
          <h2 class="p-title">{{this.title}}</h2>
          <p class="description">{{this.description}}</p>
          <p class="price"><strong>Precio:</strong> <span class="p-price">${{this.price}}</span></p>
          <p class="category"><strong>Categoría:</strong> <span class="p-category">{{this.category}}</span></p>
          <p class="stock"><strong>Stock:</strong> <span class="p-stock">{{this.stock}}</span></p>
          <p class="status">
            <strong>Estado:</strong> 
            <span class="p-status" style="{{#if this.status}}background:#27ae60{{else}}background:#e74c3c{{/if}}; color:white; padding:4px 8px; border-radius:4px; font-size:12px; display:inline-block;">{{#if this.status}}Activo{{else}}Inactivo{{/if}}</span>
          </p>
          
          <div class="product-actions">
            <a href="#" class="btn btn-info" data-action="detail" data-pid="{{this._id}}">Ver Detalles</a>
            {{#if this.status}}
              <button class="btn btn-success" data-action="add-to-cart" data-pid="{{this._id}}">Agregar al Carrito</button>
            {{/if}}
          </div>
        </div>
      {{/each}}
    </div>
  {{else}}
    <p class="no-products">No hay productos disponibles.</p>
  {{/if}}

  <!-- Paginación -->
  {{#if pagination}}
    <div class="pagination">
      <p>Página {{pagination.page}} de {{pagination.totalPages}}</p>
      
      <div class="pagination-links">
        {{#if pagination.hasPrevPage}}
          <a href="{{pagination.prevLink}}" class="btn btn-secondary">← Anterior</a>
        {{/if}}
        
        {{#if pagination.hasNextPage}}
          <a href="{{pagination.nextLink}}" class="btn btn-secondary">Siguiente →</a>
        {{/if}}
      </div>
    </div>
  {{/if}}

  <hr />

<script>
  function addToCart(productId) {
    // Obtener o crear carrito (guardado en localStorage para ejemplo)
    let cartId = localStorage.getItem('cartId');
    
    if (!cartId) {
      // Crear nuevo carrito
      fetch('/api/carts', { method: 'POST' })
        .then(res => res.json())
        .then(cart => {
          localStorage.setItem('cartId', cart._id);
          addProductToCart(cart._id, productId);
        })
        .catch(err => alert('Error al crear carrito: ' + err.message));
    } else {
      addProductToCart(cartId, productId);
    }
  }
  
  function addProductToCart(cartId, productId) {
    fetch(`/api/carts/${cartId}/products/${productId}`, { method: 'POST' })
      .then(res => res.json())
      .then(cart => {
        alert('Producto agregado al carrito');
        window.location.href = `/carts/${cartId}`;
      })
      .catch(err => alert('Error al agregar al carrito: ' + err.message));
  }
</script>
